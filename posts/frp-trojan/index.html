<!doctype html><html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>frp + trojan 组网提高网络质量 - 一个程序员的辩白</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta itemprop=name content="frp + trojan 组网提高网络质量">
<meta itemprop=description content="前段时间，家庭网络劣质化的厉害，可能是触碰到了土啬的逆鳞？
当然针对这种情况解决方法无非下面的几种情况：
 光猫重新拨号，大概率获得一个新的NAT IP，也许可以满血复活。 换一个代理节点。 用IPLC线路/IPLC转发。 代理套CDN（需要代理软件的支持）。  以上除了最后一种方法其他我都试过。
针对第三点需要特殊说明一下，由于资金的限制，我试过IPLC NAT和IPLC转发，不过感觉不是太稳定，很容易受到友商DDoS照顾，体验会比较差。
针对第四点，最近百度云加速的关于严格控制使用WebSoket协议的通知也使得CDN使用门槛变高。
另外，很多人使用Clouflare CDN来加速访问，其实是不符合其服务条款的。
 经过我一段时间的折腾，总结出了一个实际操作可行的解决方案。
整个解决方案可以浓缩为下图：
其中VPS端运行frps(frp server)，NAT device端运行frpc和代理软件，NAT device一般来说是家庭PC机、公司的VM等。
这样VPS和NAT device组成了Peer。
 当然，上面这种方式并没有解决网络劣质化的问题，一种比较理想的方式是：
  VPS为国内的云服务器。
  NAT device为公司VM，并且是专线网络（不过土啬）。
  这样本质上是利用云服务器穿透到公司网络转发出去，也即利用公司的网络当跳板，规避流量审查。
不过，第二点并不具备普遍性，可能只有部分互联网从业者有这种条件。
针对没有专线网络的情况，可以考虑使用家庭带宽，在移动设备上的网络QoS可能会好一些。 当然，这种情况没有解决开头说到的问题。
 本文将演示fatedier/frp + trojan-gfw来实现图上描述的组网方式，其他代理软件原理上是类似的。
Server side setup # 下载最新版frp V1=$(curl -sL https://api.github.com/repos/fatedier/frp/releases/latest | grep '&#34;tag_name&#34;:' | cut -d'&#34;' -f4) V2=$(echo $V1 | cut -c2-) OS=$(uname -s | tr '[:upper:]' '[:lower:]') AR=$(uname -m | sed 's/^x86_64$/amd64/') wget &#34;https://github."><meta itemprop=datePublished content="2021-01-16T00:00:00+00:00">
<meta itemprop=dateModified content="2021-01-16T00:00:00+00:00">
<meta itemprop=wordCount content="339">
<meta itemprop=keywords content="frp,trojan,proxy,"><meta property="og:title" content="frp + trojan 组网提高网络质量">
<meta property="og:description" content="前段时间，家庭网络劣质化的厉害，可能是触碰到了土啬的逆鳞？
当然针对这种情况解决方法无非下面的几种情况：
 光猫重新拨号，大概率获得一个新的NAT IP，也许可以满血复活。 换一个代理节点。 用IPLC线路/IPLC转发。 代理套CDN（需要代理软件的支持）。  以上除了最后一种方法其他我都试过。
针对第三点需要特殊说明一下，由于资金的限制，我试过IPLC NAT和IPLC转发，不过感觉不是太稳定，很容易受到友商DDoS照顾，体验会比较差。
针对第四点，最近百度云加速的关于严格控制使用WebSoket协议的通知也使得CDN使用门槛变高。
另外，很多人使用Clouflare CDN来加速访问，其实是不符合其服务条款的。
 经过我一段时间的折腾，总结出了一个实际操作可行的解决方案。
整个解决方案可以浓缩为下图：
其中VPS端运行frps(frp server)，NAT device端运行frpc和代理软件，NAT device一般来说是家庭PC机、公司的VM等。
这样VPS和NAT device组成了Peer。
 当然，上面这种方式并没有解决网络劣质化的问题，一种比较理想的方式是：
  VPS为国内的云服务器。
  NAT device为公司VM，并且是专线网络（不过土啬）。
  这样本质上是利用云服务器穿透到公司网络转发出去，也即利用公司的网络当跳板，规避流量审查。
不过，第二点并不具备普遍性，可能只有部分互联网从业者有这种条件。
针对没有专线网络的情况，可以考虑使用家庭带宽，在移动设备上的网络QoS可能会好一些。 当然，这种情况没有解决开头说到的问题。
 本文将演示fatedier/frp + trojan-gfw来实现图上描述的组网方式，其他代理软件原理上是类似的。
Server side setup # 下载最新版frp V1=$(curl -sL https://api.github.com/repos/fatedier/frp/releases/latest | grep '&#34;tag_name&#34;:' | cut -d'&#34;' -f4) V2=$(echo $V1 | cut -c2-) OS=$(uname -s | tr '[:upper:]' '[:lower:]') AR=$(uname -m | sed 's/^x86_64$/amd64/') wget &#34;https://github.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://leiless.me/posts/frp-trojan/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-01-16T00:00:00+00:00">
<meta property="article:modified_time" content="2021-01-16T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="frp + trojan 组网提高网络质量">
<meta name=twitter:description content="前段时间，家庭网络劣质化的厉害，可能是触碰到了土啬的逆鳞？
当然针对这种情况解决方法无非下面的几种情况：
 光猫重新拨号，大概率获得一个新的NAT IP，也许可以满血复活。 换一个代理节点。 用IPLC线路/IPLC转发。 代理套CDN（需要代理软件的支持）。  以上除了最后一种方法其他我都试过。
针对第三点需要特殊说明一下，由于资金的限制，我试过IPLC NAT和IPLC转发，不过感觉不是太稳定，很容易受到友商DDoS照顾，体验会比较差。
针对第四点，最近百度云加速的关于严格控制使用WebSoket协议的通知也使得CDN使用门槛变高。
另外，很多人使用Clouflare CDN来加速访问，其实是不符合其服务条款的。
 经过我一段时间的折腾，总结出了一个实际操作可行的解决方案。
整个解决方案可以浓缩为下图：
其中VPS端运行frps(frp server)，NAT device端运行frpc和代理软件，NAT device一般来说是家庭PC机、公司的VM等。
这样VPS和NAT device组成了Peer。
 当然，上面这种方式并没有解决网络劣质化的问题，一种比较理想的方式是：
  VPS为国内的云服务器。
  NAT device为公司VM，并且是专线网络（不过土啬）。
  这样本质上是利用云服务器穿透到公司网络转发出去，也即利用公司的网络当跳板，规避流量审查。
不过，第二点并不具备普遍性，可能只有部分互联网从业者有这种条件。
针对没有专线网络的情况，可以考虑使用家庭带宽，在移动设备上的网络QoS可能会好一些。 当然，这种情况没有解决开头说到的问题。
 本文将演示fatedier/frp + trojan-gfw来实现图上描述的组网方式，其他代理软件原理上是类似的。
Server side setup # 下载最新版frp V1=$(curl -sL https://api.github.com/repos/fatedier/frp/releases/latest | grep '&#34;tag_name&#34;:' | cut -d'&#34;' -f4) V2=$(echo $V1 | cut -c2-) OS=$(uname -s | tr '[:upper:]' '[:lower:]') AR=$(uname -m | sed 's/^x86_64$/amd64/') wget &#34;https://github.">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700" rel=stylesheet type=text/css>
<link rel=stylesheet type=text/css media=screen href=https://leiless.me/css/normalize.css>
<link rel=stylesheet type=text/css media=screen href=https://leiless.me/css/main.css>
<link id=dark-scheme rel=stylesheet type=text/css href=https://leiless.me/css/dark.css>
<script src=https://leiless.me/js/feather.min.js></script>
<script src=https://leiless.me/js/main.js></script>
</head>
<body>
<div class="container wrapper">
<div class=header>
<div class=avatar>
<a href=https://leiless.me/>
<img src=../../avatar.jpg alt=一个程序员的辩白>
</a>
</div>
<h1 class=site-title><a href=https://leiless.me/>一个程序员的辩白</a></h1>
<div class=site-description><nav class="nav social">
<ul class=flat><li><a href=https://github.com/leiless title=GitHub><i data-feather=github></i></a></li><li><a href=https://twitter.com/fake_fishbone title=Twitter><i data-feather=twitter></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=# class=scheme-toggle id=scheme-toggle></a></li></ul>
</nav>
</div>
<nav class=nav>
<ul class=flat>
</ul>
</nav>
</div>
<div class=post>
<div class=post-header>
<div class=meta>
<div class=date>
<span class=day>16</span>
<span class=rest>Jan 2021</span>
</div>
</div>
<div class=matter>
<h1 class=title>frp + trojan 组网提高网络质量</h1>
</div>
</div>
<div class=markdown>
<p>前段时间，家庭网络劣质化的厉害，可能是触碰到了土啬的逆鳞？</p>
<p>当然针对这种情况解决方法无非下面的几种情况：</p>
<ul>
<li>光猫重新拨号，大概率获得一个新的NAT IP，也许可以满血复活。</li>
<li>换一个代理节点。</li>
<li>用IPLC线路/IPLC转发。</li>
<li>代理套CDN（需要代理软件的支持）。</li>
</ul>
<p>以上除了最后一种方法其他我都试过。</p>
<p>针对第三点需要特殊说明一下，由于资金的限制，我试过IPLC NAT和IPLC转发，不过感觉不是太稳定，很容易受到友商DDoS照顾，体验会比较差。</p>
<p>针对第四点，最近百度云加速的<a href=https://mp.weixin.qq.com/s/q6Huos9BqC5ruJIoK88P5g>关于严格控制使用WebSoket协议的通知</a>也使得CDN使用门槛变高。</p>
<p>另外，很多人使用Clouflare CDN来加速访问，其实是<a href=https://github.com/klzgrad/naiveproxy#why-no-cdn-support>不符合其服务条款</a>的。</p>
<p> </p>
<p>经过我一段时间的折腾，总结出了<a href=https://twitter.com/fake_fishbone/status/1337984340291043328>一个实际操作可行的解决方案</a>。</p>
<p>整个解决方案可以浓缩为下图：</p>
<p><img src=../../images/frp_proxy.png alt="frp proxy"></p>
<p>其中VPS端运行<code>frps</code>(frp server)，NAT device端运行<code>frpc</code>和代理软件，NAT device一般来说是家庭PC机、公司的VM等。</p>
<p>这样VPS和NAT device组成了Peer。</p>
<p> </p>
<p>当然，上面这种方式并没有解决网络劣质化的问题，一种比较理想的方式是：</p>
<ul>
<li>
<p>VPS为国内的云服务器。</p>
</li>
<li>
<p>NAT device为公司VM，并且是专线网络（不过土啬）。</p>
</li>
</ul>
<p>这样本质上是利用云服务器穿透到公司网络转发出去，也即利用公司的网络当跳板，规避流量审查。</p>
<p>不过，第二点并不具备普遍性，可能只有部分互联网从业者有这种条件。</p>
<p>针对没有专线网络的情况，可以考虑使用家庭带宽，在移动设备上的网络QoS可能会好一些。
当然，这种情况没有解决开头说到的问题。</p>
<p> </p>
<p>本文将演示<a href=https://github.com/fatedier/frp>fatedier/frp</a> + <a href=https://github.com/trojan-gfw/trojan>trojan-gfw</a>来实现图上描述的组网方式，其他代理软件原理上是类似的。</p>
<h2 id=server-side-setup>Server side setup</h2>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:green># 下载最新版frp</span>
V1=<span style=color:#00f>$(</span>curl -sL https://api.github.com/repos/fatedier/frp/releases/latest | grep <span style=color:#a31515>&#39;&#34;tag_name&#34;:&#39;</span> | cut -d<span style=color:#a31515>&#39;&#34;&#39;</span> -f4<span style=color:#00f>)</span>
V2=<span style=color:#00f>$(</span>echo $V1 | cut -c2-<span style=color:#00f>)</span>
OS=<span style=color:#00f>$(</span>uname -s | tr <span style=color:#a31515>&#39;[:upper:]&#39;</span> <span style=color:#a31515>&#39;[:lower:]&#39;</span><span style=color:#00f>)</span>
AR=<span style=color:#00f>$(</span>uname -m | sed <span style=color:#a31515>&#39;s/^x86_64$/amd64/&#39;</span><span style=color:#00f>)</span>
wget <span style=color:#a31515>&#34;https://github.com/fatedier/frp/releases/download/</span>$V1<span style=color:#a31515>/frp_</span><span style=color:#a31515>${</span>V2<span style=color:#a31515>}</span><span style=color:#a31515>_</span><span style=color:#a31515>${</span>OS<span style=color:#a31515>}</span><span style=color:#a31515>_</span>$AR<span style=color:#a31515>.tar.gz&#34;</span>

tar xf frp_<span style=color:#a31515>${</span>V2<span style=color:#a31515>}</span>_<span style=color:#a31515>${</span>OS<span style=color:#a31515>}</span>_$AR.tar.gz
cd frp_<span style=color:#a31515>${</span>V2<span style=color:#a31515>}</span>_<span style=color:#a31515>${</span>OS<span style=color:#a31515>}</span>_$AR
</code></pre></div><p>新建<code>frps-trojan.ini</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#00f>[common]</span>
bind_port = <span style=color:#a31515>7000</span>
authentication_method = <span style=color:#a31515>token</span>
token = <span style=color:#a31515>dummy_passw0rd</span>
</code></pre></div><p><code>frps</code>监听在云服务器的<code>7000</code>端口，采用了密码认证。</p>
<p>运行<code>frps</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>./frps frps-trojan.ini
</code></pre></div><p> </p>
<h2 id=client-side-setup>Client side setup</h2>
<p>客户端的配置稍稍麻烦一点，除了<code>frpc</code>之外，还需要额外配置<code>trojan-gfw</code>。</p>
<p>下载并解压<code>frp</code>如前述，不再赘述。</p>
<p>新建<code>frpc-trojan.ini</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#00f>[common]</span>
server_addr = <span style=color:#a31515>$VPS_IP</span>
server_port = <span style=color:#a31515>7000</span>
authentication_method = <span style=color:#a31515>token</span>
token = <span style=color:#a31515>dummy_passw0rd</span>

<span style=color:#00f>[trojan-tcp]</span>
type = <span style=color:#a31515>tcp</span>
remote_port = <span style=color:#a31515>443</span>
local_ip = <span style=color:#a31515>127.0.0.1</span>
local_port = <span style=color:#a31515>1080</span>

<span style=color:#00f>[trojan-udp]</span>
type = <span style=color:#a31515>udp</span>
remote_port = <span style=color:#a31515>443</span>
local_ip = <span style=color:#a31515>127.0.0.1</span>
local_port = <span style=color:#a31515>1080</span>
</code></pre></div><p>其中，<code>$VPS_IP</code>为云服务器公网IP，来自VPS <code>frps</code>的<code>443</code>端口的流量最终将发送到NAT device的<code>127.0.0.1:1080</code>所在的进程。</p>
<p>运行<code>frpc</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>./frpc frpc-trojan.ini
</code></pre></div><h3 id=安装trojan-gfw>安装<code>trojan-gfw</code></h3>
<p>在我们的示例中，需要将<code>trojan</code>绑定(bind)到<code>127.0.0.1:1080</code>。</p>
<p>参考<a href=https://github.com/trojan-gfw/trojan-quickstart>trojan-gfw/trojan-quickstart</a>，也可以直接去<a href=https://github.com/trojan-gfw/trojan/releases>trojan-gfw/trojan</a>下载。</p>
<p><code>trojan</code>示例配置文件<code>forward.json</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    &#34;run_type&#34;: <span style=color:#a31515>&#34;forward&#34;</span>,
    &#34;local_addr&#34;: <span style=color:#a31515>&#34;127.0.0.1&#34;</span>,
    &#34;local_port&#34;: 1080,
    &#34;remote_addr&#34;: <span style=color:#a31515>&#34;$DOMAIN_NAME&#34;</span>,
    &#34;remote_port&#34;: 443,
    &#34;target_addr&#34;: <span style=color:#a31515>&#34;$DOMAIN_NAME&#34;</span>,
    &#34;target_port&#34;: 443,
    &#34;password&#34;: [
        <span style=color:#a31515>&#34;$PASSWORD&#34;</span>
    ],
    &#34;log_level&#34;: 1,
    &#34;ssl&#34;: {
        &#34;verify&#34;: <span style=color:#00f>true</span>,
        &#34;verify_hostname&#34;: <span style=color:#00f>true</span>,
        &#34;sni&#34;: <span style=color:#a31515>&#34;&#34;</span>,
        &#34;alpn&#34;: [
            <span style=color:#a31515>&#34;h2&#34;</span>,
            <span style=color:#a31515>&#34;http/1.1&#34;</span>
        ],
        &#34;reuse_session&#34;: <span style=color:#00f>true</span>,
        &#34;session_ticket&#34;: <span style=color:#00f>false</span>
    },
    &#34;tcp&#34;: {
        &#34;no_delay&#34;: <span style=color:#00f>true</span>,
        &#34;keep_alive&#34;: <span style=color:#00f>true</span>,
        &#34;reuse_port&#34;: <span style=color:#00f>true</span>,
        &#34;fast_open&#34;: <span style=color:#00f>false</span>
    }
}
</code></pre></div><p>注意<code>run_type</code>必须是<code>forward</code>，不然路由包无法被正确识别并处理。</p>
<p>其他的按照自己的配置填写即可，<code>forward.json</code>用的是域名解析方式来连接Trojan server，也可以使用IP + SNI的模式，具体参考<a href=https://trojan-gfw.github.io/trojan/config>trojan/config</a>。</p>
<p>最后运行<code>trojan</code>即可完成整个组网。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>./trojan -c forward.json
</code></pre></div><p>然后就可以在终端设备上（比如手机）测试了。</p>
<p>至此也就完成了整个组网的过程啦。</p>
<p> </p>
<h2 id=为远程办公赋能>为远程办公赋能</h2>
<p>（并不是所有公司都会为员工建立Tunnel打通到公司，更多是出于风险的考量。）</p>
<p>上面讲到的方法是将服务器作为跳板，也就是说来自终端用户的请求最终是由我们的Trojan server响应的，而不是NAT device（比如公司的机器）。</p>
<p>一个常见的场景是在家访问公司内部网络，这样需要将公司的网络作为代理响应者，而不是跳板。</p>
<p>（以下操作均在NAT device端完成）</p>
<p>第一步需要设置DNS转发，以正确解析公司内部服务的地址。</p>
<p>将以下配置追加到 <code>frpc-trojan.ini</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#00f>[dns-tcp]</span>
type = <span style=color:#a31515>tcp</span>
remote_port = <span style=color:#a31515>5353</span>
local_ip = <span style=color:#a31515>127.0.0.53</span>
local_port = <span style=color:#a31515>53</span>

<span style=color:#00f>[dns-udp]</span>
type = <span style=color:#a31515>udp</span>
remote_port = <span style=color:#a31515>5353</span>
local_ip = <span style=color:#a31515>127.0.0.53</span>
local_port = <span style=color:#a31515>53</span>
</code></pre></div><p>如果使用的是Debian/Ubuntu的话，<code>127.0.0.53:53</code>是由<a href=https://help.ubuntu.com/community/NetworkManager>NetworkManager</a>生成的聚合DNS地址，可以自动识别到上游真实的DNS，而不需要显式地填入多个地址。</p>
<p>如果不是这种情况的话，请参考<code>/etc/resolv.conf</code>里面给出的值。</p>
<p>第二步是在公司的机器上配置代理服务器，比如<code>ss/trojan/v2</code> server。</p>
<p>这样公司的服务器就作为了代理的响应者，也就是由公司的网络负责响应你的网络请求。</p>
<p>然后在<code>frpc-trojan.ini</code>追加Proxy server信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#00f>[company-proxy-tcp]</span>
type = <span style=color:#a31515>tcp</span>
local_ip = <span style=color:#a31515>127.0.0.1</span>
local_port = <span style=color:#a31515>...</span>
remote_port = <span style=color:#a31515>...</span>
...

<span style=color:#00f>[company-proxy-udp]</span>
type = <span style=color:#a31515>udp</span>
local_ip = <span style=color:#a31515>127.0.0.1</span>
local_port = <span style=color:#a31515>...</span>
remote_port = <span style=color:#a31515>...</span>
...
</code></pre></div><p>然后配置下家庭网络，就可以为远程办公赋能啦。🌚</p>
<p>需要注意的是针对以TLS流量为载体的proxy，域名需要绑定NAT VPS的IP，然后利用frp穿透转发到内网(公司/家庭)网络，然后内网的proxy再去验证证书的有效性。</p>
<p>针对透明代理，需要操作<code>iptables</code>，将家庭网络所有请求公司内部网络(LAN)的网段开启NAT转发。</p>
<p> </p>
<h2 id=注意事项>注意事项</h2>
<ul>
<li>
<p>出于安全的考虑，可以更换<code>frp</code>的端口，而不是使用默认的<code>7000</code>，并设置一个高强度的密码。</p>
</li>
<li>
<p>也可以考虑<code>frp</code>服务端<a href=https://gofrp.org/docs/reference/server-configures/>使用TLS证书加密流量</a>，以提升安全性。</p>
</li>
<li>
<p>可以在<code>frps.ini</code>设置<code>allow_ports</code>，仅允许<code>frpc</code>绑定指定的端口，详见<a href=https://gofrp.org/docs/reference/server-configures/>服务端配置</a>。</p>
</li>
<li>
<p>前述说到，VPS和NAT device组成了Peer，可以在NAT device设置防火墙，针对<code>frpc</code>，只允许来自<code>$VPS_IP</code>的访问。</p>
</li>
<li>
<p>推荐NAT device一端配置静态IP，这样从家里穿透到公司使用内网服务不用担心IP发生会变化。</p>
<p>当然，如果你的NAT device部署了暴露在公网的服务，那么可以使用<a href=https://github.com/robertdavidgraham/masscan><code>robertdavidgraham/masscan</code></a>扫描你的机器内网的IP，这样就可以做到动态LAN IP发现。</p>
<p>（静态IP的问题是如果公司内部的LAN网段发生了变化，可能会导致我们与这台NAT device失去联系）</p>
</li>
<li>
<p>如果你的云服务器的带宽比较小，可以考虑购买NAT服务器，一般来说有50M以上的带宽速率，另外VPS和NAT device的包路由都在国内，QoS也会比较好。</p>
</li>
<li>
<p>开启BBR拥塞控制算法，再<a href=https://shadowsocks.org/en/config/advanced.html>Optimize the shadowsocks server on Linux</a>，优化两端服务器的链路质量。</p>
</li>
<li>
<p>为了保证高SLA，记得用<code>systemd</code>来管理<code>frp</code>和<code>trojan/ss/v2</code>。</p>
</li>
<li>
<p>如果是在公司内虚拟化集群的VM部署的服务，需要确保你的VM在虚拟化集群重启之后会自动开机，可以<a href=https://twitter.com/fake_fishbone/status/1349716233969573893>参考这个例子</a>。</p>
</li>
<li>
<p>专线网络转发的方法仍然有被审查的风险，请合理并正确地使用。</p>
</li>
<li>
<p>针对在NAT device上跑的服务（比如<code>trojan</code>），建议将Bind Address设置为<code>127.0.0.1</code>以加强安全性。</p>
</li>
<li>
<p>从部署难以程度来说，<code>ss</code>应该是最省事的。当然也可以考虑将整个流程写一个<code>Dockerfile</code>来完成部署。</p>
</li>
<li>
<p>公司内网网段不要和家庭网络的内网网段有冲突（交集），不然可能会由于路由规则导致流量路由到本地内网从而连不上公司内网。</p>
<p>比如注意VMWare/Virtualbox的内网虚拟网络IP地址范围。</p>
</li>
<li>
<p>使用落地代理的方式（比如上面的<code>company-proxy</code>），需要注意证书到期的情况。
如果忘记更换证书，可以关闭TLS证书验证，临时登录上去更换证书，另外一个比较好的方式是使用<a href=https://github.com/acmesh-official/acme.sh>acme.sh</a>托管。</p>
</li>
</ul>
<p> </p>
<h2 id=最后>最后</h2>
<p>结尾说一下本人目前的配置，仅供参考。</p>
<ul>
<li>入口(VPS)是一台<code>200M</code>速率的NAT主机。</li>
<li>中继(NAT device)是公司Proxmox上创建的一个VM，运行Ubuntu server。</li>
<li>入口和中继节点之间的ping值小于10ms，理论上肯定越近越好。</li>
<li>公司网络是专线。</li>
<li>落地是Azure。</li>
<li>Trojan-Igniter连接Google用时500ms附近。</li>
</ul>
<p>本文受限于作者的水平，可能有描述不准确或错误的地方，请不要吝啬在评论区指出可能存在的问题。🤣</p>
<p> </p>
<h2 id=参考资料>参考资料</h2>
<blockquote>
<p><a href=https://doubibackup.com/mbofzp9h-2.html>『原创』Shadowsocks iptables 中继(中转/端口转发) 便捷管理脚本</a></p>
<p><a href=https://shadowsocks.org/en/config/advanced.html>Optimize the shadowsocks server on Linux</a></p>
<p><a href=https://gofrp.org/docs/>文档 | frp</a></p>
<p><a href=https://trojan-gfw.github.io/trojan/config>Config | trojan</a></p>
</blockquote>
</div>
<div class=tags>
<ul class=flat>
<li><a href=/tags/frp>frp</a></li>
<li><a href=/tags/trojan>trojan</a></li>
<li><a href=/tags/proxy>proxy</a></li>
</ul>
</div></div>
<script src=https://utteranc.es/client.js repo=leiless/blog issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script>
</div>
<div class="footer wrapper">
<nav class=nav>
<div>2021 Released under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> license | <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div>
</nav>
</div>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-RMJ7KLHXH8','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script>feather.replace()</script>
</body>
</html>