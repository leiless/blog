<!doctype html><html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>Oh My Zsh git status 响应过慢的解决方案 - 一个程序员的辩白</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta itemprop=name content="Oh My Zsh git status 响应过慢的解决方案">
<meta itemprop=description content="ohmyzsh/ohmyzsh内置的众多主题中大部分都支持显示git相关的信息。
比如默认的robbyrussell主题：
你可以通过
grep -IRl '$(git_prompt_info)' ~/.oh-my-zsh/themes | sort -u | xargs -I{} basename {} .zsh-theme 列出Oh My Zsh所有支持显示git status的主题。
 不过当你git clone一个有很多commit历史的Repository的时候，你就会发现Oh My Zsh在终端的体验极差，按一次回车可能需要得等好几秒。
原因是git status这个命令占用了主要的耗时，git status需要找到索引文件和工作区目录之间的差别，这就需要扫描所有的索引文件，产生大量的磁盘IO（stat(2)）。
 The most resource-intensive part of the status command is finding the difference between index and workdir (git_diff_index_to_workdir in libgit2). Index is a list of all files in the git repository with their last modification times.
https://github.com/romkatv/gitstatus#problem-statement
  以i9-9900T(8C16T), 16G RAM, 512G M."><meta itemprop=datePublished content="2021-05-13T22:38:59+08:00">
<meta itemprop=dateModified content="2021-05-13T22:38:59+08:00">
<meta itemprop=wordCount content="420">
<meta itemprop=keywords content><meta property="og:title" content="Oh My Zsh git status 响应过慢的解决方案">
<meta property="og:description" content="ohmyzsh/ohmyzsh内置的众多主题中大部分都支持显示git相关的信息。
比如默认的robbyrussell主题：
你可以通过
grep -IRl '$(git_prompt_info)' ~/.oh-my-zsh/themes | sort -u | xargs -I{} basename {} .zsh-theme 列出Oh My Zsh所有支持显示git status的主题。
 不过当你git clone一个有很多commit历史的Repository的时候，你就会发现Oh My Zsh在终端的体验极差，按一次回车可能需要得等好几秒。
原因是git status这个命令占用了主要的耗时，git status需要找到索引文件和工作区目录之间的差别，这就需要扫描所有的索引文件，产生大量的磁盘IO（stat(2)）。
 The most resource-intensive part of the status command is finding the difference between index and workdir (git_diff_index_to_workdir in libgit2). Index is a list of all files in the git repository with their last modification times.
https://github.com/romkatv/gitstatus#problem-statement
  以i9-9900T(8C16T), 16G RAM, 512G M.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://leiless.github.io/blog/posts/oh-my-zsh-git-status-slow-solution/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-05-13T22:38:59+08:00">
<meta property="article:modified_time" content="2021-05-13T22:38:59+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Oh My Zsh git status 响应过慢的解决方案">
<meta name=twitter:description content="ohmyzsh/ohmyzsh内置的众多主题中大部分都支持显示git相关的信息。
比如默认的robbyrussell主题：
你可以通过
grep -IRl '$(git_prompt_info)' ~/.oh-my-zsh/themes | sort -u | xargs -I{} basename {} .zsh-theme 列出Oh My Zsh所有支持显示git status的主题。
 不过当你git clone一个有很多commit历史的Repository的时候，你就会发现Oh My Zsh在终端的体验极差，按一次回车可能需要得等好几秒。
原因是git status这个命令占用了主要的耗时，git status需要找到索引文件和工作区目录之间的差别，这就需要扫描所有的索引文件，产生大量的磁盘IO（stat(2)）。
 The most resource-intensive part of the status command is finding the difference between index and workdir (git_diff_index_to_workdir in libgit2). Index is a list of all files in the git repository with their last modification times.
https://github.com/romkatv/gitstatus#problem-statement
  以i9-9900T(8C16T), 16G RAM, 512G M.">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700" rel=stylesheet type=text/css>
<link rel=stylesheet type=text/css media=screen href=https://leiless.github.io/blog/css/normalize.css>
<link rel=stylesheet type=text/css media=screen href=https://leiless.github.io/blog/css/main.css>
<link id=dark-scheme rel=stylesheet type=text/css href=https://leiless.github.io/blog/css/dark.css>
<script src=https://leiless.github.io/blog/js/feather.min.js></script>
<script src=https://leiless.github.io/blog/js/main.js></script>
</head><body>
<div class="container wrapper">
<div class=header>
<div class=avatar>
<a href=https://leiless.github.io/blog/>
<img src=/avatar.jpg alt=一个程序员的辩白>
</a>
</div><h1 class=site-title><a href=https://leiless.github.io/blog/>一个程序员的辩白</a></h1><div class=site-description><nav class="nav social">
<ul class=flat><li><a href=https://github.com/leiless title=GitHub><i data-feather=github></i></a></li><li><a href=https://twitter.com/space_bohemian title=Twitter><i data-feather=twitter></i></a></li><li><a href=index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=# class=scheme-toggle id=scheme-toggle></a></li></ul></nav></div><nav class=nav>
<ul class=flat>
</ul></nav></div><div class=post>
<div class=post-header>
<div class=meta>
<div class=date>
<span class=day>13</span>
<span class=rest>May 2021</span>
</div></div><div class=matter>
<h1 class=title>Oh My Zsh git status 响应过慢的解决方案</h1></div></div><div class=markdown>
<p><a href=https://github.com/ohmyzsh/ohmyzsh>ohmyzsh/ohmyzsh</a>内置的<a href=https://github.com/ohmyzsh/ohmyzsh/wiki/Themes>众多主题</a>中大部分都支持显示<code>git</code>相关的信息。</p><p>比如默认的<a href=https://github.com/ohmyzsh/ohmyzsh/wiki/Themes#robbyrussell><code>robbyrussell</code></a>主题：</p><p><img src=https://user-images.githubusercontent.com/49100982/108254738-764b8700-716c-11eb-9a59-4deb8c8c6193.jpg alt></p><p>你可以通过</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>grep -IRl <span style=color:#a31515>&#39;$(git_prompt_info)&#39;</span> ~/.oh-my-zsh/themes | sort -u | xargs -I{} basename {} .zsh-theme
</span></span></code></pre></div><p>列出Oh My Zsh所有支持显示<code>git status</code>的主题。</p><p> </p><p>不过当你<code>git clone</code>一个有很多commit历史的Repository的时候，你就会发现Oh My Zsh在终端的体验极差，按一次回车可能需要得等好几秒。</p><p>原因是<code>git status</code>这个命令占用了主要的耗时，<code>git status</code>需要找到索引文件和工作区目录之间的差别，这就需要扫描所有的索引文件，产生大量的磁盘IO（<a href=https://man7.org/linux/man-pages/man2/stat.2.html><code>stat(2)</code></a>）。</p><blockquote>
<p>The most resource-intensive part of the <code>status</code> command is finding the difference between <em>index</em> and <em>workdir</em> (<code>git_diff_index_to_workdir</code> in libgit2). Index is a list of all files in the git repository with their last modification times.</p><p><a href=https://github.com/romkatv/gitstatus#problem-statement>https://github.com/romkatv/gitstatus#problem-statement</a></p></blockquote><p> </p><p>以<code>i9-9900T(8C16T), 16G RAM, 512G M.2 NVME SSD</code>和<a href=https://github.com/chromium/chromium><code>chromium/chromium</code></a>为例，单次<code>git status</code>耗时约800ms。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ time git status --porcelain
</span></span><span style=display:flex><span>git status --porcelain  0.65s user 0.66s system 166% cpu 0.785 total
</span></span></code></pre></div><p>以2015款MacBook Pro(<code>i5-5287U 2C4T, 16G 1867MHz DDR3, 512G SATA SSD</code>)为例，单次耗时约5s。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ time git status --porcelain
</span></span><span style=display:flex><span>git status --porcelain  1.53s user 8.15s system 180% cpu 5.374 total
</span></span></code></pre></div><p> </p><p>以<a href=https://github.com/ohmyzsh/ohmyzsh/blob/master/themes/ys.zsh-theme><code>ys</code></a>主题为例，其文件路径<code>~/.oh-my-zsh/themes/ys.zsh-theme</code>，代码片断：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:green># ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># Git info</span>
</span></span><span style=display:flex><span>local git_info=<span style=color:#a31515>&#39;$(git_prompt_info)&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># Prompt format:</span>
</span></span><span style=display:flex><span><span style=color:green>#</span>
</span></span><span style=display:flex><span><span style=color:green># PRIVILEGES USER @ MACHINE in DIRECTORY on git:BRANCH STATE [TIME] C:LAST_EXIT_CODE</span>
</span></span><span style=display:flex><span><span style=color:green># $ COMMAND</span>
</span></span><span style=display:flex><span><span style=color:green>#</span>
</span></span><span style=display:flex><span><span style=color:green># For example:</span>
</span></span><span style=display:flex><span><span style=color:green>#</span>
</span></span><span style=display:flex><span><span style=color:green># % ys @ ys-mbp in ~/.oh-my-zsh on git:master x [21:47:42] C:0</span>
</span></span><span style=display:flex><span><span style=color:green># $</span>
</span></span><span style=display:flex><span>PROMPT=<span style=color:#a31515>&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>%{</span>$terminfo<span style=color:#a31515>[bold]</span>$fg<span style=color:#a31515>[blue]%}#%{</span>$reset_color<span style=color:#a31515>%} \
</span></span></span><span style=display:flex><span><span style=color:#a31515>%(#,%{</span>$bg<span style=color:#a31515>[yellow]%}%{</span>$fg<span style=color:#a31515>[black]%}%n%{</span>$reset_color<span style=color:#a31515>%},%{</span>$fg<span style=color:#a31515>[cyan]%}%n) \
</span></span></span><span style=display:flex><span><span style=color:#a31515>%{</span>$fg<span style=color:#a31515>[white]%}@ \
</span></span></span><span style=display:flex><span><span style=color:#a31515>%{</span>$fg<span style=color:#a31515>[green]%}%m \
</span></span></span><span style=display:flex><span><span style=color:#a31515>%{</span>$fg<span style=color:#a31515>[white]%}in \
</span></span></span><span style=display:flex><span><span style=color:#a31515>%{</span>$terminfo<span style=color:#a31515>[bold]</span>$fg<span style=color:#a31515>[yellow]%}%~%{</span>$reset_color<span style=color:#a31515>%}\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span><span style=color:#a31515>${</span>hg_info<span style=color:#a31515>}</span><span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span><span style=color:#a31515>${</span>git_info<span style=color:#a31515>}</span><span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span><span style=color:#a31515>${</span>venv_info<span style=color:#a31515>}</span><span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515> \
</span></span></span><span style=display:flex><span><span style=color:#a31515>%{</span>$fg<span style=color:#a31515>[white]%}[%*] </span>$exit_code<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>%{</span>$terminfo<span style=color:#a31515>[bold]</span>$fg<span style=color:#a31515>[red]%}</span>$<span style=color:#a31515> %{</span>$reset_color<span style=color:#a31515>%}&#34;</span>
</span></span></code></pre></div><p>其<code>git</code>信息的显示是通过调用<code>$(git_prompt_info)</code>来实现。<a href=https://github.com/ohmyzsh/ohmyzsh/blob/master/lib/git.zsh><code>git_prompt_info</code></a>函数实现位于文件<code>~/.oh-my-zsh/lib/git.zsh</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:green># ......</span>
</span></span><span style=display:flex><span><span style=color:#00f>function</span> __git_prompt_git() {
</span></span><span style=display:flex><span>  GIT_OPTIONAL_LOCKS=0 command git <span style=color:#a31515>&#34;</span>$@<span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>function</span> git_prompt_info() {
</span></span><span style=display:flex><span>  <span style=color:green># ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  echo <span style=color:#a31515>&#34;</span><span style=color:#a31515>${</span>ZSH_THEME_GIT_PROMPT_PREFIX<span style=color:#a31515>}${</span>ref<span style=color:#a31515>}${</span>upstream<span style=color:#a31515>}</span><span style=color:#00f>$(</span>parse_git_dirty<span style=color:#00f>)</span><span style=color:#a31515>${</span>ZSH_THEME_GIT_PROMPT_SUFFIX<span style=color:#a31515>}</span><span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># Checks if working tree is dirty</span>
</span></span><span style=display:flex><span><span style=color:#00f>function</span> parse_git_dirty() {
</span></span><span style=display:flex><span>  local STATUS
</span></span><span style=display:flex><span>  local -a FLAGS
</span></span><span style=display:flex><span>  FLAGS=(<span style=color:#a31515>&#39;--porcelain&#39;</span>)
</span></span><span style=display:flex><span>  <span style=color:#00f>if</span> [[ <span style=color:#a31515>&#34;</span><span style=color:#00f>$(</span>__git_prompt_git config --get oh-my-zsh.hide-dirty<span style=color:#00f>)</span><span style=color:#a31515>&#34;</span> != <span style=color:#a31515>&#34;1&#34;</span> ]]; <span style=color:#00f>then</span>
</span></span><span style=display:flex><span>    <span style=color:green># ......</span>
</span></span><span style=display:flex><span>    STATUS=<span style=color:#00f>$(</span>__git_prompt_git status <span style=color:#a31515>${</span>FLAGS<span style=color:#a31515>}</span> 2&gt; /dev/null | tail -1<span style=color:#00f>)</span>
</span></span><span style=display:flex><span>  <span style=color:#00f>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#00f>if</span> [[ -n $STATUS ]]; <span style=color:#00f>then</span>
</span></span><span style=display:flex><span>    echo <span style=color:#a31515>&#34;</span>$ZSH_THEME_GIT_PROMPT_DIRTY<span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#00f>else</span>
</span></span><span style=display:flex><span>    echo <span style=color:#a31515>&#34;</span>$ZSH_THEME_GIT_PROMPT_CLEAN<span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#00f>fi</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以看出，最终<code>git_prompt_info</code>会调用<code>git status --porcelain ...</code>来获取<code>git</code>相关的信息。</p><p> </p><p>最近找到一个解决Oh My Zsh <code>git status</code>过慢的方法：</p><p>利用<a href=https://github.com/romkatv/gitstatus>romkatv/gitstatus</a>作为<code>git status</code>的后端用于显示<code>git</code>当前目录的状态。</p><p>我们可以参考<a href=https://github.com/romkatv/gitstatus#using-from-zsh>Using from Zsh</a>一节的描述，利用<code>source ~/gitstatus/gitstatus.prompt.zsh</code>来达到目的。不过其默认的主题样式可能并不是你需要的。</p><p>也可以考虑<code>source ~/gitstatus/gitstatus.plugin.zsh</code>，自行定义提示信息。<code>gitstatus.plugin.zsh</code>相对与<code>gitstatus.prompt.zsh</code>而言更加地底层(low-level)。</p><p>一个比较好的方式是，<a href=https://github.com/romkatv/gitstatus>romkatv/gitstatus</a>组合我们现在正在使用的主题，这样可以做到改动最小，同时保留我们的使用习惯。</p><p>还是以<a href=https://github.com/ohmyzsh/ohmyzsh/blob/master/themes/ys.zsh-theme><code>ys</code></a>主题为例，我们可以这样修改<code>~/.oh-my-zsh/themes/ys.zsh-theme</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=font-weight:700>diff --git a/themes/ys.zsh-theme b/themes/ys.zsh-theme
</span></span></span><span style=display:flex><span><span style=font-weight:700>index 303c898b..f91467eb 100644
</span></span></span><span style=display:flex><span><span style=font-weight:700></span>--- a/themes/ys.zsh-theme
</span></span><span style=display:flex><span>+++ b/themes/ys.zsh-theme
</span></span><span style=display:flex><span><span style=font-weight:700>@@ -13,7 +13,8 @@ YS_VCS_PROMPT_DIRTY=&#34; %{$fg[red]%}x&#34;
</span></span></span><span style=display:flex><span><span style=font-weight:700></span> YS_VCS_PROMPT_CLEAN=&#34; %{$fg[green]%}o&#34;
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> # Git info
</span></span><span style=display:flex><span>-local git_info=&#39;$(git_prompt_info)&#39;
</span></span><span style=display:flex><span>+source ~/.gitstatus/gitstatus.prompt.zsh
</span></span><span style=display:flex><span>+local git_info=&#39; git:$GITSTATUS_PROMPT&#39;
</span></span><span style=display:flex><span> ZSH_THEME_GIT_PROMPT_PREFIX=&#34;${YS_VCS_PROMPT_PREFIX1}git${YS_VCS_PROMPT_PREFIX2}&#34;
</span></span><span style=display:flex><span> ZSH_THEME_GIT_PROMPT_SUFFIX=&#34;$YS_VCS_PROMPT_SUFFIX&#34;
</span></span><span style=display:flex><span> ZSH_THEME_GIT_PROMPT_DIRTY=&#34;$YS_VCS_PROMPT_DIRTY&#34;
</span></span></code></pre></div><p>然后新开一个Terminal就可以看到效果了：</p><p><img src=../../images/ys-gitst-zsh-demo.jpg alt></p><p>注意，<code>~/.zshrc</code> 里面设置的<code>ZSH_THEME</code>需要是<code>ys</code>。</p><p>当然，也可以直接使用<a href=https://github.com/romkatv/gitstatus><code>gitstatus</code></a>作者的主题<a href=https://github.com/romkatv/powerlevel10k><code>romkatv/powerlevel10k</code></a>。</p><p> </p><p>替换之后，后台会启动<code>gitstatusd</code>进程，其中<code>-t</code>是线程数，默认是CPU逻辑核心数量的两倍。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ps aux | grep <span style=color:#a31515>&#39;[g]itstatusd&#39;</span>
</span></span><span style=display:flex><span>lei       171244  0.0  0.0   6964  1068 pts/1    Sl   21:41   0:00 /home/lei/.cache/gitstatus/gitstatusd-linux-x86_64 -G v1.3.1 -s -1 -u -1 -c -1 -d -1 -v FATAL -t 32
</span></span></code></pre></div><blockquote>
<p>The diffing algorithm in gitstatusd was designed from the ground up with the intention of using it concurrently from multiple threads. With a fast SSD, <code>status</code> is CPU bound, so taking advantage of all available CPU cores is an obvious way to yield results faster.</p><p><a href=https://github.com/romkatv/gitstatus#multithreading>https://github.com/romkatv/gitstatus#multithreading</a></p></blockquote><h2 id=注意事项>注意事项</h2><ol>
<li>
<p>建议复制<code>~/.oh-my-zsh/themes</code>内的主题，修改复制的主题。主要原因在于Oh My Zsh也是一个git Repository，每次更新的时候从上游拉取更新到本地，这种情况有可能导致merge冲突进而导致Oh My Zsh更新失败。</p><p>以<a href=https://github.com/ohmyzsh/ohmyzsh/blob/master/themes/ys.zsh-theme><code>ys.zsh-theme</code></a>主题为例，我们可以将其复制为<code>ys-fastgit.zsh-theme</code>，再应用前述的修改之后，最后修改<code>~/.zshrc</code>设置<code>ZSH_THEME="ys-fastgit"</code>。</p></li></ol><h2 id=附录---完整的脚本>附录 - 完整的脚本</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone --depth=1 https://github.com/romkatv/gitstatus.git ~/.gitstatus
</span></span><span style=display:flex><span>cp ~/.oh-my-zsh/themes/ys.zsh-theme ~/.oh-my-zsh/themes/ys-fastgit.zsh-theme
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># 用</span>
</span></span><span style=display:flex><span><span style=color:green># source ~/.gitstatus/gitstatus.prompt.zsh</span>
</span></span><span style=display:flex><span><span style=color:green># local git_info=&#39; git:$GITSTATUS_PROMPT&#39;</span>
</span></span><span style=display:flex><span><span style=color:green># 替换 ys-fastgit.zsh-theme 中的</span>
</span></span><span style=display:flex><span><span style=color:green># local git_info=&#39;$(git_prompt_info)&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># 修改 ~/.zshrc 使得 ZSH_THEME=&#34;ys-fastgit&#34;</span>
</span></span></code></pre></div></div><div class=tags>
</div></div></div><div class="footer wrapper">
<nav class=nav>
<div>2022 Released under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> license | <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div></nav></div><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-RMJ7KLHXH8","auto"),ga("send","pageview"))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script>feather.replace()</script>
</body></html>