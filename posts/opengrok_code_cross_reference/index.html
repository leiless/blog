<!doctype html><html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>Using {OpenGrok to boost up source code reading - 一个程序员的辩白</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta itemprop=name content="Using {OpenGrok to boost up source code reading">
<meta itemprop=description content="Reading XNU kernel source(BSD portion) is one of my mainly job when I developing a generic kernel extension(in Apple&rsquo;s words)
Apple&rsquo;s source browser mainly generated by GNU enscript for highlighting, yet it doesn&rsquo;t support cross reference
It&rsquo;s painful when you want to cross reference a function, say, its definition, usage, etc.
As I investigated through later, I found a guy setup a XNU kernel cross reference site based on OpenGrok"><meta itemprop=datePublished content="2018-04-11T00:00:00+00:00">
<meta itemprop=dateModified content="2018-04-11T00:00:00+00:00">
<meta itemprop=wordCount content="763">
<meta itemprop=keywords content><meta property="og:title" content="Using {OpenGrok to boost up source code reading">
<meta property="og:description" content="Reading XNU kernel source(BSD portion) is one of my mainly job when I developing a generic kernel extension(in Apple&rsquo;s words)
Apple&rsquo;s source browser mainly generated by GNU enscript for highlighting, yet it doesn&rsquo;t support cross reference
It&rsquo;s painful when you want to cross reference a function, say, its definition, usage, etc.
As I investigated through later, I found a guy setup a XNU kernel cross reference site based on OpenGrok">
<meta property="og:type" content="article">
<meta property="og:url" content="https://leiless.me/posts/opengrok_code_cross_reference/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-04-11T00:00:00+00:00">
<meta property="article:modified_time" content="2018-04-11T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Using {OpenGrok to boost up source code reading">
<meta name=twitter:description content="Reading XNU kernel source(BSD portion) is one of my mainly job when I developing a generic kernel extension(in Apple&rsquo;s words)
Apple&rsquo;s source browser mainly generated by GNU enscript for highlighting, yet it doesn&rsquo;t support cross reference
It&rsquo;s painful when you want to cross reference a function, say, its definition, usage, etc.
As I investigated through later, I found a guy setup a XNU kernel cross reference site based on OpenGrok">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700" rel=stylesheet type=text/css>
<link rel=stylesheet type=text/css media=screen href=https://leiless.me/css/normalize.css>
<link rel=stylesheet type=text/css media=screen href=https://leiless.me/css/main.css>
<link id=dark-scheme rel=stylesheet type=text/css href=https://leiless.me/css/dark.css>
<script src=https://leiless.me/js/feather.min.js></script>
<script src=https://leiless.me/js/main.js></script>
</head>
<body>
<div class="container wrapper">
<div class=header>
<div class=avatar>
<a href=https://leiless.me/>
<img src=../../avatar.jpg alt=一个程序员的辩白>
</a>
</div>
<h1 class=site-title><a href=https://leiless.me/>一个程序员的辩白</a></h1>
<div class=site-description><p>关注分布式系统，DBMS，CI/CD，Deterministic Simulation。</p><nav class="nav social">
<ul class=flat><li><a href=https://github.com/leiless title=GitHub><i data-feather=github></i></a></li><li><a href=https://twitter.com/funky_fishbone title=Twitter><i data-feather=twitter></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=# class=scheme-toggle id=scheme-toggle></a></li></ul>
</nav>
</div>
<nav class=nav>
<ul class=flat>
</ul>
</nav>
</div>
<div class=post>
<div class=post-header>
<div class=meta>
<div class=date>
<span class=day>11</span>
<span class=rest>Apr 2018</span>
</div>
</div>
<div class=matter>
<h1 class=title>Using {OpenGrok to boost up source code reading</h1>
</div>
</div>
<div class=markdown>
<p>Reading <a href=https://opensource.apple.com/source/xnu>XNU kernel source</a>(BSD portion) is one of my mainly job when I developing
a generic kernel extension(in Apple&rsquo;s words)</p>
<p>Apple&rsquo;s source browser mainly generated by <a href=https://www.gnu.org/software/enscript>GNU enscript</a> for highlighting, yet it doesn&rsquo;t support cross reference</p>
<p>It&rsquo;s painful when you want to cross reference a function, say, its definition, usage, etc.</p>
<p>As I investigated through later, I found a guy setup a <a href=http://xr.anadoxin.org>XNU kernel cross reference site</a> based on OpenGrok</p>
<p>It really unleashed source code reading, which eventually make my life easier :-)</p>
<p><em>P.S.</em> Apple is ruining the good reputation over BSD documentations, it makes the BSD portion obscured, so you have to read the source code.</p>
<p> </p>
<p>Inspired by <a href=http://xr.anadoxin.org>antekone&rsquo;s cross-reference search site</a>, I finally decided I should setup one such by my own for source reading and learning.</p>
<p>Out of source reading purpose and maximum simplicity, I decided to use FreeBSD as the backend server.</p>
<p>.: the following configration is based on FreeBSD, other BSD variants follow the similar manner.</p>
<p>If you prepare to use Linux/Solaris, please move your step to <a href=https://github.com/oracle/opengrok/wiki/How-to-install-OpenGrok>OpenGrok wiki</a>.</p>
<p> </p>
<p>Once you logged in you FreeBSD server(taking 11.1 as example), you may change your default shell(which is <em>/bin/sh</em>) to bash</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:green># pkg update</span>
<span style=color:green># pkg upgrade</span>

<span style=color:green># pkg install bash bash-completion</span>

<span style=color:green># chsh -s $(which bash)</span>
</code></pre></div><p>And change current user(root) shell to bash, and then reloggin your server.</p>
<p> </p>
<h2 id=install-basic-dependencies>Install basic dependencies</h2>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>[root@bsd ~]<span style=color:green># pkg install ctags tomcat8 zip unzip</span>
</code></pre></div><h2 id=config-and-run-tomcat>Config and run tomcat</h2>
<p>Change HTTP server port to 80 in <em>/usr/local/apache-tomcat-8.0/conf/server.xml</em></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>--- server.xml.orig	2018-04-12 12:33:40.450709000 +0000
+++ server.xml	2018-04-12 12:33:58.002425000 +0000
<span style=font-weight:700>@@ -66,7 +66,7 @@
</span><span style=font-weight:700></span>          APR (HTTP/AJP) Connector: /docs/apr.html
          Define a non-SSL/TLS HTTP/1.1 Connector on port 8080
     --&gt;
-    &lt;Connector port=&#34;8080&#34; protocol=&#34;HTTP/1.1&#34;
+    &lt;Connector port=&#34;80&#34; protocol=&#34;HTTP/1.1&#34;
                connectionTimeout=&#34;20000&#34;
                redirectPort=&#34;8443&#34; /&gt;
     &lt;!-- A &#34;Connector&#34; using the shared thread pool--&gt;
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:green># Oneshot start</span>
[root@bsd ~]<span style=color:green># service tomcat8 onestart</span>

<span style=color:green># Or -- persistent service  see: init(8)</span>
[root@bsd ~]<span style=color:green># echo &#39;tomcat8_enable=&#34;YES&#34;&#39; &gt;&gt; /etc/rc.conf</span>
[root@bsd ~]<span style=color:green># service tomcat8 start</span>
</code></pre></div><p>You may open <em>http://127.0.0.1</em>(replace with your server IP) to check if tomcat is running.</p>
<p> </p>
<h2 id=download-opengrok>Download {OpenGrok</h2>
<p>Generally, you should download the latest stable <a href=https://github.com/oracle/opengrok/releases>OpenGrok release</a></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>[root@bsd ~]<span style=color:green># cd /var</span>
[root@bsd /var]<span style=color:green># fetch https://github.com/oracle/opengrok/releases/download/1.1-rc22/opengrok-1.1-rc22.tar.gz</span>
[root@bsd /var]<span style=color:green># tar xf opengrok-1.1-rc22.tar.gz</span>
[root@bsd /var]<span style=color:green># mv opengrok-1.1-rc22 opengrok</span>
[root@bsd /var]<span style=color:green># rm opengrok-1.1-rc22.tar.gz</span>
</code></pre></div><p> </p>
<h2 id=configurate-opengrok>Configurate {OpenGrok</h2>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:green># TODO:</span>
[root@bsd /var/opengrok]<span style=color:green># mkdir -p etc src data web/source</span>
</code></pre></div><p>Apply the following patch over <em>/var/opengrok/bin/OpenGrok</em></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>--- OpenGrok.orig	2018-04-11 14:44:10.165926000 +0000
+++ OpenGrok	2018-04-11 14:46:41.236225000 +0000
<span style=font-weight:700>@@ -566,6 +566,7 @@
</span><span style=font-weight:700></span>                javaHome=`dirname $javaHome`
             fi
             ;;
+        FreeBSD:*) javaHome=&#34;/usr/local/openjdk8&#34; ;;
     esac
 
     if [ -z &#34;${javaHome}&#34; ]
</code></pre></div><p> </p>
<h2 id=extract-default-web-application-package>Extract default web application package</h2>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>[root@bsd /var/opengrok]<span style=color:green># cp lib/source.war web/</span>
[root@bsd /var/opengrok/web]<span style=color:green># unzip source.war -d source</span>
</code></pre></div><p>Apply the following patch for <em>/var/opengrok/web/source/WEB-INF/web.xml</em></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>--- web.xml.orig	2018-04-11 15:13:22.680422000 +0000
+++ web.xml	2018-04-11 15:19:09.897436000 +0000
<span style=font-weight:700>@@ -12,6 +12,19 @@
</span><span style=font-weight:700></span>         &lt;param-name&gt;ConfigAddress&lt;/param-name&gt;
         &lt;param-value&gt;localhost:2424&lt;/param-value&gt;
     &lt;/context-param&gt;
+
+    &lt;context-param&gt;
+        &lt;description&gt;Source Directory containing all repositories&lt;/description&gt;
+        &lt;param-name&gt;SRC_ROOT&lt;/param-name&gt;
+        &lt;param-value&gt;/var/opengrok/src&lt;/param-value&gt;
+    &lt;/context-param&gt;
+
+    &lt;context-param&gt;
+        &lt;description&gt;Data Directory for OpenGrok&lt;/description&gt;
+        &lt;param-name&gt;DATA_ROOT&lt;/param-name&gt;
+        &lt;param-value&gt;/var/opengrok/data&lt;/param-value&gt;
+    &lt;/context-param&gt;
+
     &lt;listener&gt;
         &lt;listener-class&gt;org.opensolaris.opengrok.web.WebappListener&lt;/listener-class&gt;
     &lt;/listener&gt;
</code></pre></div><p>Repackage the web application and deploy to tomcat</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>[root@bsd /var/opengrok/web]<span style=color:green># zip -r source.war source/*</span>
[root@bsd /var/opengrok/web]<span style=color:green># cp source.war /usr/local/apache-tomcat-8.0/webapps</span>
</code></pre></div><p> </p>
<h2 id=source-code-indexing>Source code indexing</h2>
<p>As we configurated in <em>web.xml</em>, SRC_ROOT contains all source repositories.</p>
<p>We put all source code into that directory, repository per directory.</p>
<p>Taking libev as an example, I&rsquo;ll illustrate how to indexing it.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>[root@bsd /var/opengrok/src]<span style=color:green># fetch http://dist.schmorp.de/libev/libev-4.24.tar.gz</span>
[root@bsd /var/opengrok/src]<span style=color:green># tar xf libev-4.24.tar.gz</span>
<span style=color:green># The indexing may take minutes or even hours to go -- be patient</span>
[root@bsd /var/opengrok/bin]<span style=color:green># ./OpenGrok index</span>
</code></pre></div><p>When indexing finished, free free to visit <em>http://127.0.0.1/source/xref</em>(Replace with your server IP)</p>
<p> </p>
<h2 id=tips>Tips</h2>
<ul>
<li>
<p>Indexing multiple versions of a OSS, it usually a good idea to index initial, stable, latest versions.</p>
</li>
<li>
<p>Deploy an annotated version for learning, for example, <em>libev-4.24-comment</em></p>
</li>
<li>
<p><em>/usr/local/apache-tomcat-8.0/webapps/ROOT</em> contains the default pages, change to yours</p>
</li>
<li>
<p>As I tested, Firefox is outperform Chrome for viewing large files.</p>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:green># Change your time zone</span>
[root@bsd ~]<span style=color:green># ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:green># Put the indexing to background if the project is far too large</span>
[root@bsd /var/opengrok/bin]<span style=color:green># nohup ./OpenGrok index &amp;</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:green># Setup persistent swap  see: https://www.freebsd.org/doc/handbook/adding-swap-space.html</span>

[root@bsd]<span style=color:green># dd if=/dev/zero of=/swap0 bs=1m count=512</span>
[root@bsd]<span style=color:green># chmod 0600 /swap0</span>
[root@bsd]<span style=color:green># echo &#34;md99	none	swap	sw,file=/swap0,late	0	0&#34; &gt;&gt; /etc/fstab</span>
[root@bsd]<span style=color:green># swapon -aL</span>
[root@bsd]<span style=color:green># swapinfo    # Show swap info</span>
</code></pre></div><ul>
<li>Instead of extract tarballs, you can use SCM software like <em>git</em>, <em>cvs</em>, <em>svn</em> to clone repositories. Which enable history/annotate features.</li>
</ul>
<hr>
<p><del>Here is a live OpenGrok <a href=https://xr.leiless.me>cross reference research site</a> FYI</del></p>
<p><em>Happy groking!</em> :-D</p>
<p> </p>
<h2 id=references><em>References</em></h2>
<blockquote>
<p><a href=http://bxr.su>Super User&rsquo;s BSD Cross Reference</a></p>
<p><a href=http://xr.anadoxin.org>antekone&rsquo;s cross-reference search site</a> (XNU kernel)</p>
<p><a href=http://androidxref.com>AndroidXRef</a></p>
<p><a href=https://wiki.bsdforen.de/wiki:marduk:opengrok>wiki:marduk:opengrok [BSDForen.de Wiki]</a></p>
<p><a href=https://github.com/oracle/opengrok/wiki/Installations>OpenGrok use cases</a></p>
<p><a href=https://github.com/oracle/opengrok/wiki/How-to-install-OpenGrok>How to install OpenGrok</a></p>
<p><a href=http://blog.jobbole.com/79023/>最值得阅读学习的 10 个 C 语言开源项目代码</a></p>
<p><a href=https://github.com/kozross/awesome-c>Awesome C</a></p>
<p><a href=http://git.lighttpd.net/libev.git/refs/tags>libev releases #1</a></p>
<p><a href=https://github.com/YugaByte/libev>libev releases #2</a></p>
<p><a href=https://elixir.bootlin.com/linux/latest/source>Linux source code</a></p>
<p><a href=http://fxr.watson.org/>FreeBSD and Linux Kernel Cross-Reference</a></p>
</blockquote>
</div>
<div class=tags>
</div></div>
</div>
<div class="footer wrapper">
<nav class=nav>
<div>2021 Released under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> license | <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div>
</nav>
</div>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-RMJ7KLHXH8','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script>feather.replace()</script>
</body>
</html>