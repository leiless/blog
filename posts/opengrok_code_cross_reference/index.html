<!doctype html><html lang><head><meta charset=utf-8><meta name=generator content="Hugo 0.83.1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using {OpenGrok to boost up source code reading - 一个程序员的辩白"><meta name=twitter:description content="Reading XNU kernel source(BSD portion) is one of my mainly job when I developing a generic kernel extension(in Apple&amp;rsquo;s words)
Apple&amp;rsquo;s source browser mainly generated by GNU enscript for highlighting, yet it doesn&amp;rsquo;t support cross reference
It&amp;rsquo;s painful when you want to cross reference a function, say, its definition, usage, etc.
As I investigated through later, I found a guy setup a XNU kernel cross reference site based on OpenGrok"><meta name=twitter:site content="https://leiless.me/"><meta name=twitter:creator content><meta name=twitter:image content="https://leiless.me/avatar.jpg"><meta property="og:locale" content><meta property="og:type" content="article"><meta property="og:title" content="Using {OpenGrok to boost up source code reading - 一个程序员的辩白"><meta property="og:description" content="Reading XNU kernel source(BSD portion) is one of my mainly job when I developing a generic kernel extension(in Apple&amp;rsquo;s words)
Apple&amp;rsquo;s source browser mainly generated by GNU enscript for highlighting, yet it doesn&amp;rsquo;t support cross reference
It&amp;rsquo;s painful when you want to cross reference a function, say, its definition, usage, etc.
As I investigated through later, I found a guy setup a XNU kernel cross reference site based on OpenGrok"><meta property="og:url" content="https://leiless.me/posts/opengrok_code_cross_reference/"><meta property="og:site_name" content="一个程序员的辩白"><meta property="og:image" content="https://leiless.me/avatar.jpg"><title>Using {OpenGrok to boost up source code reading - 一个程序员的辩白</title><meta name=author content="Fishbone"><meta name=description content="Reading XNU kernel source(BSD portion) is one of my mainly job when I developing a generic kernel extension(in Apple&amp;rsquo;s words)
Apple&amp;rsquo;s source browser mainly generated by GNU enscript for highlighting, yet it doesn&amp;rsquo;t support cross reference
It&amp;rsquo;s painful when you want to cross reference a function, say, its definition, usage, etc.
As I investigated through later, I found a guy setup a XNU kernel cross reference site based on OpenGrok"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Arvo:400,700"><link rel=stylesheet href=https://leiless.me/css/theme.css><link rel=stylesheet href=https://leiless.me/css/chroma.dracula.css></head><body class="font-serif bg-gray-200 border-t-4 border-blue-500 antialiased"><div class="w-full p-6 md:w-2/3 md:px-0 md:mx-auto xl:w-2/5"><header class=mb-6><div class="mb-6 md:flex md:items-center"><div><a class="text-lg mb-8 inline-block" href=/>&larr; Back Home</a><h1 class="text-4xl font-bold">Using {OpenGrok to boost up source code reading</h1><time datetime="2018-04-11 00:00:00 UTC">11 Apr 2018</time></div></div></header><article class=mb-12><p>Reading <a href=https://opensource.apple.com/source/xnu>XNU kernel source</a>(BSD portion) is one of my mainly job when I developing
a generic kernel extension(in Apple&rsquo;s words)</p><p>Apple&rsquo;s source browser mainly generated by <a href=https://www.gnu.org/software/enscript>GNU enscript</a> for highlighting, yet it doesn&rsquo;t support cross reference</p><p>It&rsquo;s painful when you want to cross reference a function, say, its definition, usage, etc.</p><p>As I investigated through later, I found a guy setup a <a href=http://xr.anadoxin.org>XNU kernel cross reference site</a> based on OpenGrok</p><p>It really unleashed source code reading, which eventually make my life easier :-)</p><p><em>P.S.</em> Apple is ruining the good reputation over BSD documentations, it makes the BSD portion obscured, so you have to read the source code.</p><p> </p><p>Inspired by <a href=http://xr.anadoxin.org>antekone&rsquo;s cross-reference search site</a>, I finally decided I should setup one such by my own for source reading and learning.</p><p>Out of source reading purpose and maximum simplicity, I decided to use FreeBSD as the backend server.</p><p>.: the following configration is based on FreeBSD, other BSD variants follow the similar manner.</p><p>If you prepare to use Linux/Solaris, please move your step to <a href=https://github.com/oracle/opengrok/wiki/How-to-install-OpenGrok>OpenGrok wiki</a>.</p><p> </p><p>Once you logged in you FreeBSD server(taking 11.1 as example), you may change your default shell(which is <em>/bin/sh</em>) to bash</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># pkg update</span>
<span class=c1># pkg upgrade</span>

<span class=c1># pkg install bash bash-completion</span>

<span class=c1># chsh -s $(which bash)</span>
</code></pre></td></tr></table></div></div><p>And change current user(root) shell to bash, and then reloggin your server.</p><p> </p><h2 id=install-basic-dependencies>Install basic dependencies</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=o>[</span>root@bsd ~<span class=o>]</span><span class=c1># pkg install ctags tomcat8 zip unzip</span>
</code></pre></td></tr></table></div></div><h2 id=config-and-run-tomcat>Config and run tomcat</h2><p>Change HTTP server port to 80 in <em>/usr/local/apache-tomcat-8.0/conf/server.xml</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-diff data-lang=diff><span class=gd>--- server.xml.orig	2018-04-12 12:33:40.450709000 +0000
</span><span class=gd></span><span class=gi>+++ server.xml	2018-04-12 12:33:58.002425000 +0000
</span><span class=gi></span><span class=gu>@@ -66,7 +66,7 @@
</span><span class=gu></span>          APR (HTTP/AJP) Connector: /docs/apr.html
          Define a non-SSL/TLS HTTP/1.1 Connector on port 8080
     --&gt;
<span class=gd>-    &lt;Connector port=&#34;8080&#34; protocol=&#34;HTTP/1.1&#34;
</span><span class=gd></span><span class=gi>+    &lt;Connector port=&#34;80&#34; protocol=&#34;HTTP/1.1&#34;
</span><span class=gi></span>                connectionTimeout=&#34;20000&#34;
                redirectPort=&#34;8443&#34; /&gt;
     &lt;!-- A &#34;Connector&#34; using the shared thread pool--&gt;
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># Oneshot start</span>
<span class=o>[</span>root@bsd ~<span class=o>]</span><span class=c1># service tomcat8 onestart</span>

<span class=c1># Or -- persistent service  see: init(8)</span>
<span class=o>[</span>root@bsd ~<span class=o>]</span><span class=c1># echo &#39;tomcat8_enable=&#34;YES&#34;&#39; &gt;&gt; /etc/rc.conf</span>
<span class=o>[</span>root@bsd ~<span class=o>]</span><span class=c1># service tomcat8 start</span>
</code></pre></td></tr></table></div></div><p>You may open <em>http://127.0.0.1</em>(replace with your server IP) to check if tomcat is running.</p><p> </p><h2 id=download-opengrok>Download {OpenGrok</h2><p>Generally, you should download the latest stable <a href=https://github.com/oracle/opengrok/releases>OpenGrok release</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=o>[</span>root@bsd ~<span class=o>]</span><span class=c1># cd /var</span>
<span class=o>[</span>root@bsd /var<span class=o>]</span><span class=c1># fetch https://github.com/oracle/opengrok/releases/download/1.1-rc22/opengrok-1.1-rc22.tar.gz</span>
<span class=o>[</span>root@bsd /var<span class=o>]</span><span class=c1># tar xf opengrok-1.1-rc22.tar.gz</span>
<span class=o>[</span>root@bsd /var<span class=o>]</span><span class=c1># mv opengrok-1.1-rc22 opengrok</span>
<span class=o>[</span>root@bsd /var<span class=o>]</span><span class=c1># rm opengrok-1.1-rc22.tar.gz</span>
</code></pre></td></tr></table></div></div><p> </p><h2 id=configurate-opengrok>Configurate {OpenGrok</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># TODO:</span>
<span class=o>[</span>root@bsd /var/opengrok<span class=o>]</span><span class=c1># mkdir -p etc src data web/source</span>
</code></pre></td></tr></table></div></div><p>Apply the following patch over <em>/var/opengrok/bin/OpenGrok</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-diff data-lang=diff><span class=gd>--- OpenGrok.orig	2018-04-11 14:44:10.165926000 +0000
</span><span class=gd></span><span class=gi>+++ OpenGrok	2018-04-11 14:46:41.236225000 +0000
</span><span class=gi></span><span class=gu>@@ -566,6 +566,7 @@
</span><span class=gu></span>                javaHome=`dirname $javaHome`
             fi
             ;;
<span class=gi>+        FreeBSD:*) javaHome=&#34;/usr/local/openjdk8&#34; ;;
</span><span class=gi></span>     esac
 
     if [ -z &#34;${javaHome}&#34; ]
</code></pre></td></tr></table></div></div><p> </p><h2 id=extract-default-web-application-package>Extract default web application package</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=o>[</span>root@bsd /var/opengrok<span class=o>]</span><span class=c1># cp lib/source.war web/</span>
<span class=o>[</span>root@bsd /var/opengrok/web<span class=o>]</span><span class=c1># unzip source.war -d source</span>
</code></pre></td></tr></table></div></div><p>Apply the following patch for <em>/var/opengrok/web/source/WEB-INF/web.xml</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-diff data-lang=diff><span class=gd>--- web.xml.orig	2018-04-11 15:13:22.680422000 +0000
</span><span class=gd></span><span class=gi>+++ web.xml	2018-04-11 15:19:09.897436000 +0000
</span><span class=gi></span><span class=gu>@@ -12,6 +12,19 @@
</span><span class=gu></span>         &lt;param-name&gt;ConfigAddress&lt;/param-name&gt;
         &lt;param-value&gt;localhost:2424&lt;/param-value&gt;
     &lt;/context-param&gt;
<span class=gi>+
</span><span class=gi>+    &lt;context-param&gt;
</span><span class=gi>+        &lt;description&gt;Source Directory containing all repositories&lt;/description&gt;
</span><span class=gi>+        &lt;param-name&gt;SRC_ROOT&lt;/param-name&gt;
</span><span class=gi>+        &lt;param-value&gt;/var/opengrok/src&lt;/param-value&gt;
</span><span class=gi>+    &lt;/context-param&gt;
</span><span class=gi>+
</span><span class=gi>+    &lt;context-param&gt;
</span><span class=gi>+        &lt;description&gt;Data Directory for OpenGrok&lt;/description&gt;
</span><span class=gi>+        &lt;param-name&gt;DATA_ROOT&lt;/param-name&gt;
</span><span class=gi>+        &lt;param-value&gt;/var/opengrok/data&lt;/param-value&gt;
</span><span class=gi>+    &lt;/context-param&gt;
</span><span class=gi>+
</span><span class=gi></span>     &lt;listener&gt;
         &lt;listener-class&gt;org.opensolaris.opengrok.web.WebappListener&lt;/listener-class&gt;
     &lt;/listener&gt;
</code></pre></td></tr></table></div></div><p>Repackage the web application and deploy to tomcat</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=o>[</span>root@bsd /var/opengrok/web<span class=o>]</span><span class=c1># zip -r source.war source/*</span>
<span class=o>[</span>root@bsd /var/opengrok/web<span class=o>]</span><span class=c1># cp source.war /usr/local/apache-tomcat-8.0/webapps</span>
</code></pre></td></tr></table></div></div><p> </p><h2 id=source-code-indexing>Source code indexing</h2><p>As we configurated in <em>web.xml</em>, SRC_ROOT contains all source repositories.</p><p>We put all source code into that directory, repository per directory.</p><p>Taking libev as an example, I&rsquo;ll illustrate how to indexing it.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=o>[</span>root@bsd /var/opengrok/src<span class=o>]</span><span class=c1># fetch http://dist.schmorp.de/libev/libev-4.24.tar.gz</span>
<span class=o>[</span>root@bsd /var/opengrok/src<span class=o>]</span><span class=c1># tar xf libev-4.24.tar.gz</span>
<span class=c1># The indexing may take minutes or even hours to go -- be patient</span>
<span class=o>[</span>root@bsd /var/opengrok/bin<span class=o>]</span><span class=c1># ./OpenGrok index</span>
</code></pre></td></tr></table></div></div><p>When indexing finished, free free to visit <em>http://127.0.0.1/source/xref</em>(Replace with your server IP)</p><p> </p><h2 id=tips>Tips</h2><ul><li><p>Indexing multiple versions of a OSS, it usually a good idea to index initial, stable, latest versions.</p></li><li><p>Deploy an annotated version for learning, for example, <em>libev-4.24-comment</em></p></li><li><p><em>/usr/local/apache-tomcat-8.0/webapps/ROOT</em> contains the default pages, change to yours</p></li><li><p>As I tested, Firefox is outperform Chrome for viewing large files.</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># Change your time zone</span>
<span class=o>[</span>root@bsd ~<span class=o>]</span><span class=c1># ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># Put the indexing to background if the project is far too large</span>
<span class=o>[</span>root@bsd /var/opengrok/bin<span class=o>]</span><span class=c1># nohup ./OpenGrok index &amp;</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># Setup persistent swap  see: https://www.freebsd.org/doc/handbook/adding-swap-space.html</span>

<span class=o>[</span>root@bsd<span class=o>]</span><span class=c1># dd if=/dev/zero of=/swap0 bs=1m count=512</span>
<span class=o>[</span>root@bsd<span class=o>]</span><span class=c1># chmod 0600 /swap0</span>
<span class=o>[</span>root@bsd<span class=o>]</span><span class=c1># echo &#34;md99	none	swap	sw,file=/swap0,late	0	0&#34; &gt;&gt; /etc/fstab</span>
<span class=o>[</span>root@bsd<span class=o>]</span><span class=c1># swapon -aL</span>
<span class=o>[</span>root@bsd<span class=o>]</span><span class=c1># swapinfo    # Show swap info</span>
</code></pre></td></tr></table></div></div><ul><li>Instead of extract tarballs, you can use SCM software like <em>git</em>, <em>cvs</em>, <em>svn</em> to clone repositories. Which enable history/annotate features.</li></ul><hr><p><del>Here is a live OpenGrok <a href=https://xr.leiless.me>cross reference research site</a> FYI</del></p><p><em>Happy groking!</em> :-D</p><p> </p><h2 id=references><em>References</em></h2><blockquote><p><a href=http://bxr.su>Super User&rsquo;s BSD Cross Reference</a></p><p><a href=http://xr.anadoxin.org>antekone&rsquo;s cross-reference search site</a> (XNU kernel)</p><p><a href=http://androidxref.com>AndroidXRef</a></p><p><a href=https://wiki.bsdforen.de/wiki:marduk:opengrok>wiki:marduk:opengrok [BSDForen.de Wiki]</a></p><p><a href=https://github.com/oracle/opengrok/wiki/Installations>OpenGrok use cases</a></p><p><a href=https://github.com/oracle/opengrok/wiki/How-to-install-OpenGrok>How to install OpenGrok</a></p><p><a href=http://blog.jobbole.com/79023/>最值得阅读学习的 10 个 C 语言开源项目代码</a></p><p><a href=https://github.com/kozross/awesome-c>Awesome C</a></p><p><a href=http://git.lighttpd.net/libev.git/refs/tags>libev releases #1</a></p><p><a href=https://github.com/YugaByte/libev>libev releases #2</a></p><p><a href=https://elixir.bootlin.com/linux/latest/source>Linux source code</a></p><p><a href=http://fxr.watson.org/>FreeBSD and Linux Kernel Cross-Reference</a></p></blockquote><script src=https://utteranc.es/client.js repo=leiless/blog issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article><footer><p><a href=https://leiless.me/>一个程序员的辩白</a> <span style=color:gray>&copy;</span> 2017 - 2021. Proudly made with <a href=https://gohugo.io/ target=_blank>Hugo</a> and <a href=https://tailwindcss.com/ target=_blank>TailwindCSS</a>.</p><p style=margin-top:-15px;font-size:10px>Released under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> license.</p></footer></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-RMJ7KLHXH8"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-RMJ7KLHXH8',{anonymize_ip:!1})}</script><script>(function(a,c,d,e){if(typeof a.webpushr!='undefined')return;a.webpushr=a.webpushr||function(){(a.webpushr.q=a.webpushr.q||[]).push(arguments)};var b,f=c.getElementsByTagName(d)[0];b=c.createElement(d),b.id=e,b.async=1,b.src="https://cdn.webpushr.com/app.min.js",f.parentNode.appendChild(b)})(window,document,'script','webpushr-jssdk'),webpushr('setup',{key:'BJji5mvLAV3k-EncfEEH_CtK_CdcXWnXc-fvhs7uY1jfOG4xX_RsBmoWvTD0OTyq6TOEB5G5_uFE6Ylpxj5MKEQ'})</script></body></html>